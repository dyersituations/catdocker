on:
  workflow_dispatch:
    inputs:
      domain:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out catdocker repo
        uses: actions/checkout@v4
      - name: Check out catcms repo
        uses: actions/checkout@v4
        with:
          repository: dyersituations/catcms
          path: catcms
      - name: Create SECRET_KEY_BASE
        run: |
          echo "::add-mask::$SECRET_KEY_BASE"
          echo "SECRET_KEY_BASE=$(openssl rand -hex 64)" >> $GITHUB_ENV
      - name: Create .env file
        run: |
          touch $GITHUB_WORKSPACE/${{ inputs.domain }}/.env
          echo RAILS_ENV=production >> .env
          echo SECRET_KEY_BASE=${{ env.SECRET_KEY_BASE }} >> .env
          cat $GITHUB_WORKSPACE/${{ inputs.domain }}/.env
      - name: Build images
        run: docker-compose build -f "${{ inputs.domain }}/docker-compose.yml" --no-cache
